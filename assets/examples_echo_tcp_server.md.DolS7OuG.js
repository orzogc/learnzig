import{_ as s,c as i,o as a,a6 as n}from"./chunks/framework.C3vgFeqS.js";const h="/zig-course/assets/tcp.drawio.erPD3zQV.png",k="/zig-course/assets/tcp_poll.drawio.DHdRdXop.png",o=JSON.parse('{"title":"Echo TCP Server","description":"","frontmatter":{"outline":"deep"},"headers":[],"relativePath":"examples/echo_tcp_server.md","filePath":"examples/echo_tcp_server.md","lastUpdated":1708606907000}'),l={name:"examples/echo_tcp_server.md"},p=n('<h1 id="echo-tcp-server" tabindex="-1">Echo TCP Server <a class="header-anchor" href="#echo-tcp-server" aria-label="Permalink to &quot;Echo TCP Server&quot;">â€‹</a></h1><p>æˆ‘ä»¬æ¥è¿›è¡Œç¼–å†™ä¸€ä¸ªå°å°çš„ç¤ºä¾‹â€”â€”â€”â€” Echo TCP Server(TCP å›æ˜¾ server)ï¼Œå¸®åŠ©æˆ‘ä»¬ç†è§£æ›´å¤šçš„å†…å®¹ã€‚</p><blockquote><p>ä»£ç ä¸€å…±ä¹Ÿå°±ä¸€ç™¾è¡Œå·¦å³ï¼Œç®€æ´ä½†ä¸ç®€å•ï¼</p></blockquote><h2 id="å‰ç½®çŸ¥è¯†" tabindex="-1">å‰ç½®çŸ¥è¯† <a class="header-anchor" href="#å‰ç½®çŸ¥è¯†" aria-label="Permalink to &quot;å‰ç½®çŸ¥è¯†&quot;">â€‹</a></h2><h3 id="socket" tabindex="-1">Socket <a class="header-anchor" href="#socket" aria-label="Permalink to &quot;Socket&quot;">â€‹</a></h3><p>Socketï¼ˆå¥—æ¥å­—ï¼‰æ˜¯è®¡ç®—æœºç½‘ç»œä¸­ç”¨äºå®ç°ä¸åŒè®¡ç®—æœºæˆ–åŒä¸€å°è®¡ç®—æœºä¸Šçš„ä¸åŒè¿›ç¨‹ä¹‹é—´çš„é€šä¿¡çš„ä¸€ç§æŠ€æœ¯ã€‚å®ƒæä¾›äº†ä¸€ç§æ ‡å‡†çš„ APIï¼Œç¨‹åºå‘˜å¯ä»¥ä½¿ç”¨è¿™ä¸ª API æ¥ç¼–å†™ç½‘ç»œåº”ç”¨ç¨‹åºã€‚</p><p>ä¸€ä¸ªSocketç”±ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆï¼š<strong>åè®®</strong>ã€<strong>æœ¬åœ°åœ°å€</strong>å’Œ<strong>è¿œç¨‹åœ°å€</strong>ï¼Œåè®®å†³å®šäº†Socketçš„ç±»å‹å’Œé€šä¿¡æ–¹å¼ï¼Œä¾‹å¦‚TCPæˆ–UDPï¼Œæœ¬åœ°åœ°å€æ˜¯Socketç»‘å®šçš„ç½‘ç»œæ¥å£å’Œç«¯å£å·ï¼Œè¿œç¨‹åœ°å€æ˜¯Socketè¿æ¥çš„ç›®æ ‡ç½‘ç»œæ¥å£å’Œç«¯å£å·ã€‚</p><p>é™¤äº†å¸¸è§çš„ <strong>TCP</strong> å’Œ <strong>UDP</strong> å¤–ï¼Œè¿˜æœ‰ä¸€ç§å«åš <strong>Unix Socket</strong>ï¼Œç”¨äºåœ¨åŒä¸€å°æœºå™¨ä¸Šçš„ä¸åŒè¿›ç¨‹é—´è¿›è¡Œé€šä¿¡ï¼Œå¹¶ä¸ä½¿ç”¨ç½‘ç»œåè®®æ ˆï¼Œè€Œæ˜¯ç›´æ¥åœ¨å†…æ ¸ä¸­ä¼ é€’æ•°æ®ï¼Œæ¯” TCP å’Œ UDP æ›´åŠ é«˜æ•ˆã€‚</p><h3 id="ioå¤šè·¯å¤ç”¨" tabindex="-1">IOå¤šè·¯å¤ç”¨ <a class="header-anchor" href="#ioå¤šè·¯å¤ç”¨" aria-label="Permalink to &quot;IOå¤šè·¯å¤ç”¨&quot;">â€‹</a></h3><p><strong>I/O å¤šè·¯å¤ç”¨</strong>æ˜¯ä¸€ç§å…è®¸ä¸€ä¸ªè¿›ç¨‹åŒæ—¶ç›‘è§†å¤šä¸ª I/O é€šé“ï¼ˆä¾‹å¦‚ï¼Œ<em>socket</em>ã€<em>æ–‡ä»¶æè¿°ç¬¦</em>ç­‰ï¼‰ï¼Œå¹¶çŸ¥é“å“ªä¸ªé€šé“å¯ä»¥è¿›è¡Œè¯»å†™æ“ä½œçš„æŠ€æœ¯ã€‚è¿™æ ·ï¼Œä¸€ä¸ªè¿›ç¨‹å°±å¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ª I/O æ“ä½œï¼Œè€Œæ— éœ€ä¸ºæ¯ä¸ª I/O æ“ä½œå¯åŠ¨ä¸€ä¸ªæ–°çš„çº¿ç¨‹æˆ–è¿›ç¨‹ã€‚</p><blockquote><p>I/O å¤šè·¯å¤ç”¨çš„ä¸»è¦ä¼˜ç‚¹æ˜¯æé«˜äº†ç¨‹åºçš„æ•ˆç‡ã€‚å¦‚æœæ²¡æœ‰ I/O å¤šè·¯å¤ç”¨ï¼Œç¨‹åºå¯èƒ½éœ€è¦ä¸ºæ¯ä¸ª I/O æ“ä½œåˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹æˆ–è¿›ç¨‹ï¼Œè¿™ä¼šæ¶ˆè€—å¤§é‡çš„ç³»ç»Ÿèµ„æºã€‚é€šè¿‡ä½¿ç”¨ I/O å¤šè·¯å¤ç”¨ï¼Œç¨‹åºå¯ä»¥åœ¨ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹æˆ–è¿›ç¨‹ä¸­å¤„ç†å¤šä¸ª I/O æ“ä½œï¼Œä»è€Œå‡å°‘äº†ç³»ç»Ÿèµ„æºçš„ä½¿ç”¨ã€‚</p></blockquote><p>I/O å¤šè·¯å¤ç”¨çš„å¸¸è§å®ç°åŒ…æ‹¬ selectã€poll å’Œ epoll ç­‰ç³»ç»Ÿè°ƒç”¨ã€‚è¿™äº›ç³»ç»Ÿè°ƒç”¨å…è®¸ç¨‹åºæŒ‡å®šä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦åˆ—è¡¨ï¼Œå¹¶ç­‰å¾…å…¶ä¸­ä»»ä½•ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦å‡†å¤‡å¥½è¿›è¡Œ I/O æ“ä½œã€‚å½“ä¸€ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦å‡†å¤‡å¥½æ—¶ï¼Œç³»ç»Ÿè°ƒç”¨è¿”å›ï¼Œç¨‹åºå°±å¯ä»¥è¿›è¡Œç›¸åº”çš„è¯»æˆ–å†™æ“ä½œã€‚</p><h2 id="æ€è·¯è®²è§£" tabindex="-1">æ€è·¯è®²è§£ <a class="header-anchor" href="#æ€è·¯è®²è§£" aria-label="Permalink to &quot;æ€è·¯è®²è§£&quot;">â€‹</a></h2><p>ç›®æ ‡ï¼šå®ç°ä¸€ä¸ªå•çº¿ç¨‹åŸºäº <code>poll</code> çš„ <strong>echo server</strong>ã€‚</p><p>å¸¸è§„çš„ socket ç¼–ç¨‹æµç¨‹ä¸ºï¼š</p><ol><li><code>socket( )</code></li><li><code>bind( )</code></li><li><code>listen( )</code></li><li><code>accept( )</code></li><li><code>read( )</code></li><li><code>write( )</code></li><li><code>close( )</code></li></ol><p><img src="'+h+'" alt="tcp"></p><p>ä»¥ä¸Šæ˜¯ä¸€ä¸ªå¸¸è§„çš„ TCP server çš„è¿ä½œå›¾ï¼Œä½†æ˜¯ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œé‚£å°±æ˜¯è¿™æ ·è¿è¡Œçš„è¯ server ä¸€æ¬¡åªèƒ½å¤„ç†ä¸€ä¸ªè¿æ¥ï¼Œæ— æ³•å®ç°å¹¶å‘è¿æ¥ã€‚</p><p>æ•…æˆ‘ä»¬å¼•å…¥ <code>poll</code>ï¼Œå®ƒæ˜¯ POSIX æ ‡å‡†ä¹‹ä¸€ï¼Œå…è®¸æˆ‘ä»¬é€šçŸ¥å†…æ ¸æ›¿æˆ‘ä»¬ç›‘å¬å¤šä¸ªæè¿°ç¬¦ï¼ˆæ­¤å¤„æŒ‡ä»£ socket æè¿°ç¬¦ï¼‰ï¼Œä»¥ä¸€ç§è®¢é˜…çš„æ–¹æ¡ˆæ¥ç›‘å¬ä¸€ç»„æè¿°ç¬¦ï¼Œç›´åˆ°æè¿°ç¬¦å¯è¯»æˆ–å†™æ—¶é€šçŸ¥è¿›ç¨‹å°±ç»ªçš„æè¿°ç¬¦æ•°é‡ã€‚</p><div class="info custom-block"><p class="custom-block-title">ğŸ…¿ï¸ æç¤º</p><p>ä¸¥æ ¼æ¥è¯´ï¼Œ<strong>poll</strong> å·²ç»ç®—æ˜¯ä¸€é—¨â€œè¿‡æ—¶â€çš„æŠ€æœ¯ï¼Œåœ¨ linux å¹³å°å®ƒè¢« <strong>epoll</strong> å–ä»£ï¼ŒBSD ç³»ç»Ÿï¼ˆåŒ…æ‹¬ mac ï¼‰åˆ™ä½¿ç”¨ <strong>kqueue</strong>ï¼Œè€Œ windows ä½¿ç”¨ <strong>IOCPï¼ˆI/O Completion Portsï¼‰</strong> å’Œ <strong>Overlapped I/O</strong>ã€‚</p><p>WSAPoll For Windows: <a href="https://learn.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-wsapoll" target="_blank" rel="noreferrer">WSAPoll function</a></p><p>Poll For Linux: <a href="https://man7.org/linux/man-pages/man2/poll.2.html" target="_blank" rel="noreferrer">poll(2) â€” Linux manual page</a></p></div><p>ä»¥ä¸‹æ˜¯ä½¿ç”¨ <code>poll</code> åçš„è¿ä½œå›¾ï¼š</p><p><img src="'+k+`" alt="tcp"></p><h2 id="å®æˆ˜" tabindex="-1">å®æˆ˜ <a class="header-anchor" href="#å®æˆ˜" aria-label="Permalink to &quot;å®æˆ˜&quot;">â€‹</a></h2><p>ä¸ºäº†åŒæ—¶å…¼å®¹ linux å’Œ windowsï¼Œæˆ‘ä»¬éœ€è¦åˆ©ç”¨ä¸€ä¸‹ zig çš„ <code>builtin</code> åŒ…æ¥åˆ¤æ–­æ„å»ºç›®æ ‡æ¥å†³å®šä½¿ç”¨çš„å‡½æ•°ï¼ˆpoll åœ¨ windows ä¸Šçš„å®ç°ä¸å®Œå…¨æ ‡å‡†ï¼‰ã€‚</p><p>å®Œæ•´çš„ä»£ç åœ¨ <a href="https://github.com/zigcc/zig-course/tree/main/course/code/11/echo_tcp_server.zig" target="_blank" rel="noreferrer">Github</a>ï¼Œè¯•ç”¨çš„å®¢æˆ·ç«¯å¯ä»¥ä½¿ç”¨ <em>telent</em> ï¼ˆwindows å’Œ linux å‡å¯ç”¨ï¼‰ã€‚</p><p><em>server</em> ç›‘å¬ç«¯å£çš„å®ç°ï¼š</p><div class="language-zig vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">zig</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è§£æåœ°å€</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> port</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">8080</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> address</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">try</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> net</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">Address</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">parseIp4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;127.0.0.1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">port</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// åˆå§‹åŒ–ä¸€ä¸ªserverï¼Œè¿™é‡Œå°±åŒ…å«äº† socket() å’Œ bind() ä¸¤ä¸ªè¿‡ç¨‹</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">var</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> server</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">net</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">StreamServer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">init</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">net</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">StreamServer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">Options</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{ .</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">reuse_port</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">defer</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> server</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">deinit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å¼€å§‹listen</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">try</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> server</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">listen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">address</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><p>å®šä¹‰ä¸€äº›å¿…è¦çš„æ•°æ®ï¼š</p><div class="language-zig vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">zig</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å®šä¹‰æœ€å¤§è¿æ¥æ•°</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> max_sockets</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// buffer ç”¨äºå­˜å‚¨ client å‘è¿‡æ¥çš„æ•°æ®</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">var</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> buf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1024</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">u8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">std</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">mem</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">zeroes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1024</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">u8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å­˜å‚¨ accept æ‹¿åˆ°çš„ connections</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">var</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> connections</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">max_sockets</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]?</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">net</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">StreamServer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">Connection</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">undefined</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// sockfds ç”¨äºå­˜å‚¨ pollfd, ç”¨äºä¼ é€’ç»™ poll å‡½æ•°</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">var</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> sockfds</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">max_sockets</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">pollfd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">undefined</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><p>å¤„ç†å®¢æˆ·ç«¯å‘é€çš„æ•°æ®çš„å®ç°ï¼š</p><div class="language-zig vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">zig</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// éå†æ‰€æœ‰çš„è¿æ¥ï¼Œå¤„ç†äº‹ä»¶</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">..</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">max_sockets</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // è¿™é‡Œçš„ nums æ˜¯ poll è¿”å›çš„äº‹ä»¶æ•°é‡</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // åœ¨windowsä¸‹ï¼ŒWSApollå…è®¸è¿”å›0ï¼Œæœªè¶…æ—¶ä¸”æ²¡æœ‰å¥—æ¥å­—å¤„äºæŒ‡å®šçš„çŠ¶æ€</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">nums</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> sockfd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">sockfds</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">i</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // å½“å‰ sock æœ‰ IO äº‹ä»¶æ—¶ï¼Œå¤„ç†å®Œåå°† nums å‡ä¸€</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    defer</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">sockfd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">revents</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">        nums</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // æ£€æŸ¥æ˜¯å¦æ˜¯æ— æ•ˆçš„ socket</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">sockfd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">fd</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ==</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">INVALID_SOCKET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        continue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // æ£€æŸ¥æ˜¯å¦æ˜¯ POLLIN äº‹ä»¶ï¼Œå³æ˜¯å¦æœ‰æ•°æ®å¯è¯»</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">sockfd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">revents</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">POLLIN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> c</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">connections</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">i</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">c</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">connection</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            const</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> len</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">try</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> connection</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">stream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">read</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">buf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // å¦‚æœè¿æ¥å·²ç»æ–­å¼€ï¼Œé‚£ä¹ˆå…³é—­è¿æ¥</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // è¿™æ˜¯å› ä¸ºå¦‚æœå·²ç» close çš„è¿æ¥ï¼Œè¯»å–çš„æ—¶å€™ä¼šè¿”å›0</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">len</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                // ä½†ä¸ºäº†ä¿é™©èµ·è§ï¼Œæˆ‘ä»¬è¿˜æ˜¯è°ƒç”¨ close</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                // å› ä¸ºæœ‰å¯èƒ½æ˜¯è¿æ¥æ²¡æœ‰æ–­å¼€ï¼Œä½†æ˜¯å‡ºç°äº†é”™è¯¯</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">                connection</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">stream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">close</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                // å°† pollfd å’Œ connection ç½®ä¸ºæ— æ•ˆ</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">                sockfds</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">i</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">fd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">INVALID_SOCKET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">                std</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;client from {any} close!&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, .{</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">                    connection</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">address</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                });</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">                connections</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">i</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] = </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                // å¦‚æœè¯»å–åˆ°äº†æ•°æ®ï¼Œé‚£ä¹ˆå°†æ•°æ®å†™å›å»</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                // ä½†ä»…ä»…è¿™æ ·å†™ä¸€æ¬¡å¹¶ä¸å®‰å…¨</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                // æœ€ä¼˜è§£åº”è¯¥æ˜¯ä½¿ç”¨forå¾ªç¯æ£€æµ‹å†™å…¥çš„æ•°æ®å¤§å°æ˜¯å¦ç­‰äºbufé•¿åº¦</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                // å¦‚æœä¸ç­‰äºå°±ç»§ç»­å†™å…¥</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                // è¿™æ˜¯å› ä¸º TCP æ˜¯ä¸€ä¸ªé¢å‘æµçš„åè®®ï¼Œå®ƒå¹¶ä¸ä¿è¯ä¸€æ¬¡ write è°ƒç”¨èƒ½å¤Ÿå‘é€æ‰€æœ‰çš„æ•°æ®</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                // ä½œä¸ºç¤ºä¾‹ï¼Œæˆ‘ä»¬ä¸æ£€æŸ¥æ˜¯å¦å…¨éƒ¨å†™å…¥</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">                _</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">try</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> connection</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">stream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">write</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">buf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">..</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">len</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // æ£€æŸ¥æ˜¯å¦æ˜¯ POLLNVAL | POLLERR | POLLHUP äº‹ä»¶ï¼Œå³æ˜¯å¦æœ‰é”™è¯¯å‘ç”Ÿï¼Œæˆ–è€…è¿æ¥æ–­å¼€</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    else</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">sockfd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">revents</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">POLLNVAL</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">POLLERR</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">POLLHUP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // å°† pollfd å’Œ connection ç½®ä¸ºæ— æ•ˆ</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">        sockfds</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">i</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">fd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">INVALID_SOCKET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">        connections</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">i</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] = </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">        std</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;client {} close&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, .{</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">i</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>å¤„ç†æ–°è¿æ¥çš„å®ç°ï¼š</p><div class="language-zig vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">zig</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„è¿æ¥</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è¿™é‡Œçš„ sockfds[0] æ˜¯ server çš„ pollfd</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è¿™é‡Œçš„ nums æ£€æŸ¥å¯æœ‰å¯æ— ï¼Œå› ä¸ºæˆ‘ä»¬åªå…³å¿ƒæ˜¯å¦æœ‰æ–°çš„è¿æ¥ï¼ŒPOLLIN å°±è¶³å¤Ÿäº†</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">sockfds</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">revents</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">POLLIN</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> and</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> nums</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // å¦‚æœæœ‰æ–°çš„è¿æ¥ï¼Œé‚£ä¹ˆè°ƒç”¨ accept</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> client</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">try</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> server</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">accept</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">..</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">max_sockets</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // æ‰¾åˆ°ä¸€ä¸ªç©ºçš„ pollfdï¼Œå°†æ–°çš„è¿æ¥æ”¾è¿›å»</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">sockfds</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">i</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">fd</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ==</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">INVALID_SOCKET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">            sockfds</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">i</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">fd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">client</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">stream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">            connections</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">i</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] = </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">client</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">            std</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;new client {} comes&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, .{</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">i</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç©ºçš„ pollfdï¼Œé‚£ä¹ˆè¯´æ˜è¿æ¥æ•°å·²ç»è¾¾åˆ°äº†æœ€å¤§å€¼</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ==</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> max_sockets</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            @panic</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;too many clients&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div>`,33),t=[p];function e(E,r,d,g,y,F){return a(),i("div",null,t)}const A=s(l,[["render",e]]);export{o as __pageData,A as default};
